name: 'PHPCS'
on:
  workflow_call:
    secrets:
      access-token:
        description: 'GitHub Access Token'
        required: true
    inputs:
      ref:
        description: 'Git Commit Ref (branch, tag, or hash)'
        required: true
        type: string
      php_version:
        description: 'PHP Version'
        required: false
        type: string
        default: '7.4'
jobs:
  phpcs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      # ------------------------------------------------------------------------------
      # Prepare our cache directories
      # ------------------------------------------------------------------------------
      - name: Get Composer Cache Directory
        id: get-composer-cache-dir
        run: |
          echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
      - uses: actions/cache@v4
        id: composer-cache
        with:
          path: ${{ steps.get-composer-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - uses: "shivammathur/setup-php@v2"
        with:
          php-version: ${{ inputs.php_version }}
      - uses: "ramsey/composer-install@v2"
        with:
          composer-options: "--ignore-platform-reqs"

      - name: "Give permissions"
        run: |
          sudo chown -R root:root $GITHUB_WORKSPACE

      # ------------------------------------------------------------------------------
      # Get changed files
      # ------------------------------------------------------------------------------
      - name: Get list of changed files
        id: files
        run: |
          echo "CHANGED_FILES=$(git diff --name-only --diff-filter=AM ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- . ':!tests' | grep '\.php$' | tr '\n' ' ')" >> $GITHUB_ENV

      # ------------------------------------------------------------------------------
      # PHPCS
      # ------------------------------------------------------------------------------
      - uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest # Optional. [latest,nightly,v.X.Y.Z]
      - name: Run reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.access-token }}
        run: |
          # Run phpcs and capture both the output and the exit code
          JSON_REPORT=$(vendor/bin/phpcs --report=json ${{ env.CHANGED_FILES }} || echo "")
          PHPCS_EXIT_CODE=$?

          # Check if phpcs produced a JSON report
          if [ -z "$JSON_REPORT" ]; then
            echo "No JSON report generated by phpcs"
            exit $PHPCS_EXIT_CODE
          fi

          # Validate the JSON
          if ! echo "$JSON_REPORT" | jq empty; then
            echo "Invalid JSON"
            exit 1
          fi

          # Process JSON and run reviewdog
          echo "$JSON_REPORT" | jq -r ' .files | to_entries[] | .key as $path | .value.messages[] as $msg | "\($path):\($msg.line):\($msg.column):`\($msg.source)`<br>\($msg.message)" ' | reviewdog -efm="%f:%l:%c:%m" -name="phpcs" -filter-mode="added" -fail-on-error=true -reporter=github-pr-review

          # Exit with the original phpcs exit code
          exit $PHPCS_EXIT_CODE
